---
title: "Произвольный линукс в контейнере"
description: "Саморучно меняем дистрибутив внутри OpenVZ-контейнера."
categories: [сервер, ubuntu, virtuozzo, openvz, masterhost]
layout: post
time: 22:58:01
lang: ru
---
<p>Началось все с того, что техподдержка мастерхоста отказала в установке операционки на наш выбор. А разрешается на их виртуальные серверы ставить только дебиан 5, федору 7 и центос 5. Пятый дебиан полностью устроил бы, если бы в нем уже был <a href="http://upstart.ubuntu.com/">апстарт</a>, а будет апстарт только в шестой версии. И без него никак. А так как операционки на наших старых серверах уже давно устарели (Ubuntu 6.10 последовательно обновленная до 8.04), пришла пора все менять.</p>

<p>У нас в офисе уже полтора года вертится <a href="/posts/2009/04/28/mac-os-leopard-launchd-vboxheadless/">несколько OpenVZ-контейнеров</a>. Для домашних нужд все подходит просто прекрасно. Вдобавок, из экспериментов с OpenVZ удалось вынести несколько полезных наблюдений. Вот они, кстати. Чистый виртуозный контейнер — это всего-лишь небольшая папочка да один конфиг. Готовых контейнеров с разными дистрибутивами линукса <a href="http://wiki.openvz.org/Download/template/precreated">пруд пруди</a>. Всей виртуализации в OpenVZ, по большому счету: изоляция файловой системы, разделение памяти и процессора, да айпишников. Ядро одно на всех, тип файловой системы — один, и никакой магии с виртуализацией устройств. А еще свою виртуалку внутри контейнера не запустишь (если только полноценный эмулятор запустить). Итого, с одной стороны — никакой тонкой настройки под железо, а с другой — никакого геморроя с этим железом. Вдобавок, возможен интересный трюк, о котором эта статья.</p>

<p>Итак. Ось можно элементарно заменить, удалив все файлы старой системы и заменив файлами из новой. Конечно, в процессе надо не уронить уже запущенную систему и суметь потом попасть в новую. Иначе получим кирпич вместо сервера. И, да, прочитайте, пожалуйста, весь пост до конца, чтобы понять, сумеете ли вы потом получить доступ к новой системе, или, хотя бы, восстановить старую.</p>

<h3>Подготовительный этап</h3>

<ul>
	<li>делаем полный бекап контейнера (лучше создайте новый и мучайте его);</li>
	<li>заходим под рутом по SSH;</li>
	<li>создаем папочку <code>new-system</code> там, где вам удобно;</li>
	<li>скачиваем в <code>new-system</code> образ новой оси (у меня это <code>ubuntu-10.04-x86.tar.gz</code>);</li>
	<li>заходим в <code>new-system</code> и распаковываем образ (<code>tar xzf ubuntu-10.04-x86.tar.gz</code>).</li>
</ul>

<p>В итоге, папочка <code>new-system</code> (у меня <code>/root/new-system</code>) содержит структуру каталогов новенькой операционки. На следующем шаге мы заменим текущую операционку новой. Только, вот один важный момент. В данном примере новая система родственна старой (сестрички Ubuntu 10.04 и Debian 5.0), поэтому надо будет заменить всего несколько папок, оставив остальные нетронутыми. Если вы собираетесь менять федору на генту, будьте готовы немного поэкспериментировать.</p>

<h3>Заеняем системные файлы</h3>

<p>Для того, чтобы сократить период перехода системы из одного состояния в другое, не стоит сразу удалять папки старой системы. Достаточно переименовать их, а на их место переместить новые. Так как мы заменяем все привычные программы, типа <code>mv</code>, <code>rm</code>, <code>mkdir</code>, придется делать все вручную прямо из sftp-клиента.</p>

<ul>
	<li>переименовываем эти папки новой системы: <code>bin</code>, <code>dev</code>, <code>etc</code>, <code>lib</code>, <code>sbin</code>, <code>usr</code>, <code>var</code>, во что-то типа <code>bin1</code>, <code>dev1</code>, <code>etc1</code> и т.д.;</li>
	<li>перемещаем переименованные папки из <code>new-system</code> в корень, они встанут бок о бок с папками текущей оси;</li>
	<li>одну за другой переименовываем получившиеся пары по такому шаблону <code>bin</code> ⟶ <code>bin0</code>, <code>bin1</code> ⟶ <code>bin</code>.</li>
</ul>

<p>Перезагружаемся. Запустится новая система. Так как мы развернули кем-то заранее подготовленный образ, в нем уже будет запущен <code>sshd</code>. Только вот пароль рута будет другой. Если вы обновляли контейнер на хостинге с контрольной панелью (которая, на 4643-м порту), то можете смело менять его оттуда. Можно схитрить и сохранить файл <code>/root/.ssh/authorized_keys</code> от старой системы. Тогда нас пустят по ключу, и можно будет спокойно менять пароль рута через <code>passwd</code>. Теперь оставшиеся от старой системы папки можно спокойно удалять (или архивировать на память).</p>


<p>П.С. У нас контейнеры такие: <code>Linux vXXXX.vps.masterhost.ru 2.6.18-028stab070.7 #1 SMP Fri Oct 1 13:53:00 MSD 2010 i686 GNU/Linux</code>.</p>