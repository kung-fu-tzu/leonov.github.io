<!DOCTYPE html>
<html lang="ru">
<head>
	<title>Быстрый ответ — Блог Конфуция</title>
	<!--# include virtual="/inc/common-head.html" -->
</head>
<body>
<!--# include virtual="/inc/common-top.html" -->
<div class="main-wrapper">

<a href="/" class="blog-name">Блог Конфуция</a>

<div class="post">
	<section>
		<h class="title">Быстрый ответ</h>
		<span class="date">15.12.2008</span>
		<section class="content">
		<p>Если генерировать ответ постепенно, не зная заранее его размер, то нжинкс попытается отдать его клиенту чанками. Если клиент не поддерживает HTTP/1.1, то нжинкс откажется от кипэлайва. Это совсем не здорово, так как после отправки придется разорвать соединение и устанавливать новое.</p>

<p>Конечно, яваскрипт может перед отправкой заголовков сложить все данные в одну строку, вычислить длину строки и передать ответ. Проблема заключается в том, что <code>string.length</code> вернет именно длину строки, а не количество байт в ней. Чтобы узнать длину той строки, которую нжинкс будет реально передавать, надо сначала попросить SpiderMonkey сконвертировать внутреннюю строку (UTF-16) в обычную (ASCII, UTF-8), а затем уже вычислить ее длину. К этой работе добавляется манипуляция заголовками из яваскрипта. Это еще один вызов метода и несколько проверок входных/выходных параметров.</p>

<p>Все эти действия будут лишними, если единственная цель вычисления длины строки — это отправка заголовка <code>Content-length</code>. Разумно будет завернуть все необходимые действия в один нативный метод и передать ему только строку с данными. В таком случае мы экономим немного времени, что полезно, если результат запроса уже закеширован в какой-либо переменной, и его надо очень быстро отправить.</p>

<p>Вот пример яваскрипта:
<pre><code class="javascript">
function processRequest (r)
{
	r.sendString("Привет, Девелопер!")
	return Nginx.OK
}
</code></pre>
Эта функция умеет отдавать строку «Привет, Девелопер!» 15 000 раз в секунду. Без кипэлайва будет всего около 6000. Если попытаться еще немного соптимизировать, можно кешировать и ascii-строку и ее длину между обращениями к <code>sendString()</code>. Строки в яваскрипте изменять нельзя, поэтому такое кеширование легко реализовать. Для длинных строк это может быть очень полезно.</p>
		</section>
	</section>
	
	<dl class="tags">
		<dt class="head">Теги:</dt>
		<dd class="body">
			<ul class="list"><li class="tag">сервер</li><li class="tag">benchmark</li><li class="tag">javascript</li><li class="tag">keep-alive</li><li class="tag">nginx</li></ul>
		</dd>
	</dl>
	
	<div class="comments">Очень жду ваших комментариев <a href="mailto:Комментарии блога Конфуция <comments@kung-fu-tzu.ru>?subject=Re: Быстрый ответ">на почту</a>.</div>
</div>

</div>
<!--# include virtual="/inc/common-bottom.html" -->
</body>
</html>