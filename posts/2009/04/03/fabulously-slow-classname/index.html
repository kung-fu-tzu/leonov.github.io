<!DOCTYPE html>
<html lang="ru">
<head>
	<title>Сказочно медленный className — Блог Конфуция</title>
	<!--# include virtual="/inc/common-head.html" -->
</head>
<body>
<!--# include virtual="/inc/common-top.html" -->
<div class="main-wrapper">

<a href="/" class="blog-name">Блог Конфуция</a>

<div class="post">
	<section>
		<h class="title">Сказочно медленный className</h>
		<span class="date">03.04.2009</span>
		<section class="content">
		<p>Как выяснилось, лучше выполнить кучу предварительных проверок в яваскрипте, и только потом, при крайней необходимости, трогать <code>className</code>. Дело в том, что это свойство затратно не только записать, но и прочитать. Тормозить будет даже в том случае, когда фактическое значение не меняется (<code>node.className = node.className</code>).</p>

<p>Почему так происходит, легко понять из кода, которым обвязывается каждое обращение к свойству оборачиваемого объекта (в данном случае обернут элемент DOM-дерева). Такая обвязка, как правило, состоит из внушительного куска кода, который выясняет, какое именно свойство вызвано, а потом ищет, как это свойство прочитать или записать. Поиск чаще используется простой, перебором. Затем, управление передается дальше. Наверняка, это будет вызов некоторого метода. Метод сделает что-то свое (возможно, просто возвратит строку, а может и другие методы повызывает). И напоследок, результат работы метода необходимо обернуть в подходящий яваскриптовый объект. В нашем случае это строка. А строку еще надо создать, выделить память под символы (предварительно посчитав, сколько байт нужно), скопировать в нее данные, вернувшиеся из метода (почти наверняка, перекодировав в UTF-16), и только потом возвратить управление яваскрипту.</p>

<p>Пример грустный от того, что в нем перечислена куча действий, от которых можно отказаться. Однако, отказаться от них очень непросто, и это потребует от разработчиков браузера много терпения и желания сделать людям быстро. Такие оптимизации как раз ведут к тому, что называется быстрым ДОМом (<a href="http://www.google.com/search?q=faster+dom+site%3Aajaxian.com">faster DOM</a>).</p>

<p>Мы можем немного помочь разработчикам браузеров, если научим свою страничку кешировать значение className. Таким образом, этот код в фаерфоксе будет быстрее:
<pre><code class="javascript">
cache = 'a'
cache = className = cache + ' b'
</code></pre>
чем этот:
<pre><code class="javascript">
className += ' b'
</code></pre></p>

<p>Когда появится свободное время, дополню пост парой бенчмарков, а пока, остается верить мне на слово ;)</p>
		</section>
	</section>
	
	<dl class="tags">
		<dt class="head">Теги:</dt>
		<dd class="body">
			<ul class="list"><li class="tag">клиент</li><li class="tag">className</li><li class="tag">DOM</li><li class="tag">performance</li></ul>
		</dd>
	</dl>
	
	<div class="comments">Очень жду ваших комментариев <a href="mailto:Комментарии блога Конфуция <comments@kung-fu-tzu.ru>?subject=Re: Сказочно медленный className">на почту</a>.</div>
</div>

</div>
<!--# include virtual="/inc/common-bottom.html" -->
</body>
</html>