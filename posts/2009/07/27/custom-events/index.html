<!DOCTYPE html>
<html lang="ru">
<head>
	<title>Кастомные события — Блог Конфуция</title>
	<!--# include virtual="/inc/common-head.html" -->
</head>
<body>
<!--# include virtual="/inc/common-top.html" -->
<div class="main-wrapper">

<a href="/" class="blog-name">Блог Конфуция</a>

<div class="post">
	<section>
		<h class="title">Кастомные события</h>
		<span class="date">27.07.2009</span>
		<section class="content">
		<p>Во всех браузерах, кроме сами знаете какого, можно играться с событийным движком браузера, как душе угодно. Гибкость дается наравне с нативными событиями: можно называть их как угодно, настраивать всплываемость и отменяемость, добавлять свои свойства и методы. Такие трюки удобны для создания виджетов со своей моделью событий; и для имитации полезных событий браузера там, где их не поддерживают (типа, <code>onready</code> или <code>onhashchanged</code>); а еще для расширения базовой логики приложения кем-то третьим (например, события <code>hide</code>/<code>show</code> для отключения анимации в скрытых нодах); да мало ли для чего еще могли бы пригодиться свои собственные события. Но не в IE.</p>

<p>Событийную модель можно реализовать на яваскрипте, и воспользоваться всеми этими прелестями. Но только не для нод в дереве документа, а для простых обектов (тут ничего нового — очередная реализация интерфейса EventTarget). А ведь хочется вешать обработчики именно на ноды, документ, окно… на аяксовый запрос, наконец!</p>

<p>Решили научить IE распространять по документу выдуманные типы событий и посмотреть, что из этого выйдет. У этой задачи есть простое решение: достатачно на яваскрипте повторить движок браузера для подписки/отписки и распространения событий. Код получается интересный, так что это решение вполне приемлемо. С другой стороны, зачем дублировать то, что уже реализовали нативно, а значит быстро. Надо всего-то чуть-чуть допилить браузер.</p>

<p>В этом случае можно выбрать некоторое событие как транспорт. Это событие должно по умолчанию всплывать и не иметь никаких встроенных обработчиков. Поискав немного, нашел <code>oneditfocus</code>. Мы его нигде не используем, а по параметрам он подходит как раз. На нем, пока, и остановился — самое сложное позади. Далее дело техники: научить <code>addEventListener</code> и <code>dispathEvent</code> понимать, какие события обрабатывать как есть, а какие оборачивать в <code>oneditfocus</code>. Здесь тоже ничего сложного: ищем событие в списке нативных и, если не нашли — оборачиваем.</p>

<p>В итоге, за наши труды получаем такой код, без проблем работающий в IE 6-7-8:
<pre><code class="javascript">
window.addEventListener("ready", function (e) { alert("got an event type " + e.type) }, false)
var ready = document.createEvent("Event")
ready.initEvent("ready", true, true)
window.dispathEvent(ready)
//=> got event type ready
</code></pre></p>

<p>Конечно, IE не поддерживает ни <code>addEventListener</code>, ни <code>dispathEvent</code>, но их поддержку нетрудно добавить.</p>

<p><strong>UPD</strong>: <a href="http://dean.edwards.name/">Дин Эдвардс</a> сделал работающую модель событий для IE в своей библиотеке <a href="http://code.google.com/p/base2/">Base2</a>. Она показалась мне громоздкой и сумбурной. Да и стиль кодирования Дина меня тоже не особо прет: все эти точки с запятой, бее ;)</p>
		</section>
	</section>
	
	<dl class="tags">
		<dt class="head">Теги:</dt>
		<dd class="body">
			<ul class="list"><li class="tag">клиент</li><li class="tag">events</li><li class="tag">fixes</li><li class="tag">IE</li></ul>
		</dd>
	</dl>
	
	<div class="comments">Очень жду ваших комментариев <a href="mailto:Комментарии блога Конфуция <comments@kung-fu-tzu.ru>?subject=Re: Кастомные события">на почту</a>.</div>
</div>

</div>
<!--# include virtual="/inc/common-bottom.html" -->
</body>
</html>