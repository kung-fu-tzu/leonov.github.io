<!DOCTYPE html>
<html lang="ru">
<head>
	<title>Обновляем виртуозную убунту — Блог Конфуция</title>
	<!--# include virtual="/inc/common-head.html" -->
</head>
<body>
<!--# include virtual="/inc/common-top.html" -->
<div class="main-wrapper">

<a href="/" class="blog-name">Блог Конфуция</a>

<div class="post">
	<section>
		<h class="title">Обновляем виртуозную убунту</h>
		<span class="date">06.01.2009</span>
		<section class="content">
		<p><strong>UPD</strong>: Умные вещи <a href="http://blog.antage.name/posts/бэкпортинг-на-ubuntu-610-edgy.html">про бэкпортинг</a>.</p>

<p>< strong >UPD: При обновлении до харди не обязательно проходить всю цепочку edgy → feisty → gutsy → hardy (так как это уже невозможно), достаточно сразу записать в <code>/etc/apt/sources.list</code> везде hardy. Если будет ругаться на что-то связанное с tzdata (например, <code>Could not perform immediate configuration (2) on tzdata</code>), то достаточно удалить этот пакет: <code>apt-get remove tzdata</code>. Он потом все равно установится в процессе обновления.</p>

<p>
Решил переехать со старой ubuntu 6.10 (можно было и с 6.06, но уже поздно) на новую ubuntu 8.04 внутри контейнера Virtuozzo на мастерхосте. Конфигурация, как видите, мудреная, и без эксцессов не обошлось.
</p>

<p>
Сначала проапгрейдил систему через смену репозиториев, запуская для каждого <code>apt-get update</code> и <code>apt-get dist-upgrade</code>. Это рисковано, но сработало. Перезагрузив VPS, обнаружил, что он не запускается и висит на стадии запуска <code>klogd</code>. Поговорил с техподдержкой, и это, как ни странно, помогло: пока мы болтали с тетей из мастерхоста, сервак загрузился. Он, оказывается, не висел, а просто долго чего-то ждал. После отключения <code>/etc/init.d/klogd</code> система стала стабильно загружаться за несколько секунд.
</p>

<p>
Дальше — интереснее. Обнаружил, что убунта больше не использует <code>sysvinit</code>, а вместо него все запускается с помощью их нового апстарта (<a href="http://upstart.ubuntu.com/">upstart</a>). Почитал про него и понял, что этот новый апстарт есть именно то, что нужно. Он умеет загружать все параллельно, построен на событиях и — что главное для боевого сервера — умеет красиво респавнить упавшие демоны.
</p>

<p>
Как же это здорово, подумалось мне тогда. Вот сейчас заиспользую этот чудесный апстарт. Но не тут-то было. Он при апгрейде не установился. Команда <code>cat /etc/issue</code> пишет <code>Ubuntu 8.04 \n \l</code>, а апстарта нету. Как же так?
</p>

<p>
Ну, ничего. Мы же на каникулах — сейчас и апстарт поставим.
<pre><code class="bash">
apt-get install startup-tasks system-services \
    upstart-compat-sysv upstart-logd
</code></pre>
Поставил, и сервер напрочь отказался запускаться. После нажатия кнопки запуска в панели управления сервер работал около двух секунд и снова становился выключенным. Но это не беда, у меня остался полный бекап системы.
</p>

<p>
Как отлаживать такой черный ящик — непонятно. Выход нашелся очень забавный. Если VPS выключен, то через панель управления смотреть и править его файлы нельзя. Режима восстановления у мастерхостовского виртуоза нету. Однако, если в начале файла <code>/etc/init.d/rc</code> поставить <code>sleep 600</code>, то можно 10 минут спокойно лазить по файлам на еще не загруженном сервере. Не очень удобно, но уже что-то. Дальше обнаружилось, что до сбоя логи не пишутся никакие, хотя, процессы инициализации запускаются.
</p>

<p>
С помощью метода научного тыка, строки <code>echo OK > my-debug.log</code> и моральной поддержи кота Шарика (в пять утра не спит только кот и его программист) обнаружил, что сервак убивает одна единственная строка <code>kill -USR1 1</code> в <code>/etc/init.d/mountall.sh</code>. Видимо, новая версия апстарта из моего сервера от такой грубости падала, и виртуоз решал, что пора сервер выключать, раз инит уже свалился. Повторю, мастерхостовский виртуоз делал все это очень быстро и очень молча. Хитрец такой.
</p>

<p>
Если вы знаете быстрый, надежный и не очень недорогой VPS-хостинг с адекватными версиями линуксов и возможностью отладки, поделитесь со мной пожалуйста… ну, пожалуйста, пожалуйста, пожалуйста, пожалуйста ;)
</p>
		</section>
	</section>
	
	<dl class="tags">
		<dt class="head">Теги:</dt>
		<dd class="body">
			<ul class="list"><li class="tag">сервер</li><li class="tag">ubuntu</li><li class="tag">virtuozzo</li><li class="tag">openvz</li><li class="tag">masterhost</li><li class="tag">upstart</li></ul>
		</dd>
	</dl>
	
	<div class="comments">Очень жду ваших комментариев <a href="mailto:Комментарии блога Конфуция <comments@kung-fu-tzu.ru>?subject=Re: Обновляем виртуозную убунту">на почту</a>.</div>
</div>

</div>
<!--# include virtual="/inc/common-bottom.html" -->
</body>
</html>